<style>
dialog::backdrop {
  background: rgba(30, 81, 89, 0.4);
  backdrop-filter: blur(6px);
}

.custom-modal {
  border: none;
  border-radius: 24px;
  width: 95%;
  max-width: 520px;
  padding: 0;
  background: white;
  box-shadow: 0 25px 60px rgba(30, 81, 89, 0.2);
  animation: modalFade 0.25s ease-out;
  place-self: center;
}

@keyframes modalFade {
  from { opacity: 0; transform: translateY(20px) scale(0.97); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-header {
  padding: 24px 28px 0 28px;
}

.modal-body {
  padding: 20px 28px 28px 28px;
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.modal-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--ecosense-secondary);
}

.input-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.input-group label {
  font-weight: 600;
  font-size: 14px;
  color: var(--ecosense-secondary);
  opacity: 0.9;
}

.input-group input,
.input-group select,
.input-group textarea {
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid rgba(30, 81, 89, 0.2);
  background: white;
  font-size: 14px;
  transition: 0.2s;
  color: var(--ecosense-secondary);
}

.input-group input:focus,
.input-group select:focus,
.input-group textarea:focus {
  outline: none;
  border-color: var(--ecosense-primary);
  box-shadow: 0 0 0 3px rgba(118, 192, 221, 0.25);
}

.row-2 {
  display: flex;
  gap: 14px;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 10px;
}

.btn-cancel {
  padding: 10px 18px;
  border-radius: 14px;
  border: none;
  background: rgba(30, 81, 89, 0.1);
  color: var(--ecosense-secondary);
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}

.btn-cancel:hover {
  background: rgba(30, 81, 89, 0.15);
}

.btn-primary {
  padding: 10px 18px;
  border-radius: 14px;
  border: none;
  background: var(--ecosense-primary);
  color: var(--ecosense-secondary);
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(118, 192, 221, 0.35);
  transition: 0.2s;
}

.btn-primary:hover {
  background: var(--ecosense-primary-dark);
  color: white;
}

#open-create-node-modal:hover {
  background: var(--ecosense-primary-dark);
  color: white;
  box-shadow: 0 16px 40px rgba(118, 192, 221, 0.4);
}

#nodes-tbody button {
  transition: 0.2s;
}
#nodes-tbody button:hover {
  opacity: 0.85;
  transform: scale(1.03);
}

#nodes-tbody tr {
  transition: 0.2s;
}
#nodes-tbody tr:hover {
  background: var(--ecosense-primary-soft-1);
}

/* Tabla: encabezado con paleta Ecosense */
.nodes-table thead {
  background: var(--ecosense-secondary) !important;
  color: white !important;
}
.nodes-table thead th {
  border-bottom: 1px solid var(--ecosense-secondary-dark);
  border-right: 1px solid rgba(255, 255, 255, 0.12);
  cursor: pointer;
  user-select: none;
}
.nodes-table thead th:last-child {
  border-right: none;
  cursor: default;
}
.nodes-table tbody td {
  border-bottom: 1px solid rgba(30, 81, 89, 0.08);
  border-right: 1px solid rgba(30, 81, 89, 0.06);
}
.nodes-table tbody td:last-child {
  border-right: none;
}
.nodes-table thead th:hover {
  background: var(--ecosense-secondary-dark);
}
.th-sort-icon {
  margin-left: 4px;
  opacity: 0.8;
  font-size: 16px;
  vertical-align: middle;
}

/* Buscador y controles */
.table-toolbar {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 16px;
  padding: 16px 20px;
  background: white;
  border-bottom: 1px solid rgba(30, 81, 89, 0.08);
}
.table-search {
  flex: 1;
  min-width: 220px;
  padding: 10px 16px 10px 40px;
  border-radius: 12px;
  border: 1px solid rgba(30, 81, 89, 0.2);
  font-size: 14px;
  color: var(--ecosense-secondary);
  background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%231e5159' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") no-repeat 12px center;
}
.table-search:focus {
  outline: none;
  border-color: var(--ecosense-primary);
  box-shadow: 0 0 0 2px rgba(118, 192, 221, 0.25);
}
.table-search::placeholder {
  color: var(--ecosense-secondary);
  opacity: 0.6;
}

/* Paginaci贸n */
.table-pagination {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 14px 20px;
  background: white;
  border-top: 1px solid rgba(30, 81, 89, 0.08);
  flex-wrap: wrap;
}
.pagination-btn {
  min-width: 36px;
  height: 36px;
  padding: 0 10px;
  border-radius: 10px;
  border: 1px solid rgba(30, 81, 89, 0.2);
  background: white;
  color: var(--ecosense-secondary);
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.pagination-btn:hover:not(:disabled) {
  background: var(--ecosense-primary-soft-2);
  border-color: var(--ecosense-primary);
}
.pagination-btn.active {
  background: var(--ecosense-primary);
  color: white;
  border-color: var(--ecosense-primary);
}
.pagination-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.pagination-info {
  font-size: 13px;
  color: var(--ecosense-secondary);
  opacity: 0.85;
  margin-right: auto;
}
</style>


<div style="font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif; min-height: 100vh; background: var(--ecosense-primary-soft-1);">
  <!-- NAVBAR UNIFICADA -->
  <div style="
  backdrop-filter: blur(20px);
  background: linear-gradient(135deg, var(--ecosense-primary-soft-1) 0%, var(--ecosense-primary-soft-2) 100%);
  padding: 10px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(30,81,89,0.08);
  position: sticky;
  top: 0;
  z-index: 100;
">
    <!-- Logo -->
    <a href={~p"/"} style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
      <img
        src={~p"/images/EcosenseLogo.png"}
        alt="Ecosense"
        style="height: 80px; padding: 0px 25px;"
      />
    </a>
    <div class="flex items-center gap-4">
      <span style="font-size: 12px; color: var(--ecosense-secondary); opacity: 0.7;">v1.0</span>

      <!-- CTA a dashboard -->
      <a
        href={~p"/dashboard"}
        style="
          background: var(--ecosense-tertiary);
          color: var(--ecosense-secondary);
          padding: 8px 18px;
          border-radius: 999px;
          font-weight: 600;
          text-decoration: none;
          display: inline-flex;
          align-items: center;
          gap: 6px;
        "
      >
        <span class="material-symbols-outlined" style="font-size: 20px;">monitoring</span>
        Dashboards
      </a>

      <!-- Men煤 de procesos (ruedita) -->
      <div class="relative" style="position: relative;" id="settings-dropdown-container">
        <button
          type="button"
          id="settings-button"
          class="flex items-center justify-center"
          style="
            width: 36px;
            height: 36px;
            border-radius: 999px;
            border: 1px solid rgba(30,81,89,0.16);
            background: rgba(255,255,255,0.7);
            color: var(--ecosense-secondary);
            cursor: pointer;
          "
        >
          <span class="material-symbols-outlined" style="font-size: 22px;">settings</span>
        </button>

        <!-- Dropdown -->
        <div
          id="settings-dropdown"
          style="
            display: none;
            position: absolute;
            right: 0;
            margin-top: 8px;
            background: white;
            color: var(--ecosense-secondary);
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.25);
            padding: 8px 0;
            min-width: 220px;
            z-index: 1000;
          "
        >
          <a
            href={~p"/manage/nodes"}
            style="
              display: flex;
              align-items: center;
              gap: 8px;
              padding: 8px 16px;
              text-decoration: none;
              color: inherit;
              font-size: 14px;
            "
            onmouseover="this.style.backgroundColor='rgba(118,192,221,0.15)';"
            onmouseout="this.style.backgroundColor='transparent';"
          >
            <span class="material-symbols-outlined" style="font-size: 20px;">hub</span>
            Configurar nodos
          </a>

          <a
            href={~p"/manage/sensors"}
            style="
              display: flex;
              align-items: center;
              gap: 8px;
              padding: 8px 16px;
              text-decoration: none;
              color: inherit;
              font-size: 14px;
            "
            onmouseover="this.style.backgroundColor='rgba(118,192,221,0.15)';"
            onmouseout="this.style.backgroundColor='transparent';"
          >
            <span class="material-symbols-outlined" style="font-size: 20px;">sensors</span>
            Configurar sensores
          </a>

          <form action={~p"/logout"} method="post" style="margin: 0;">
            <input type="hidden" name="_csrf_token" value={get_csrf_token()} />
            <input type="hidden" name="_method" value="delete" />
            <button
              type="submit"
              style="
                width: 100%;
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 16px;
                background: transparent;
                border: none;
                cursor: pointer;
                font-size: 14px;
                color: inherit;
              "
              onmouseover="this.style.backgroundColor='rgba(232,38,89,0.1)';"
              onmouseout="this.style.backgroundColor='transparent';"
            >
              <span class="material-symbols-outlined" style="font-size: 20px; color: var(--ecosense-negative);">logout</span>
              Cerrar sesi贸n
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div style="max-width: 1400px; margin: auto; padding: 60px 24px;">
    <!-- Header + Create Button -->
    <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 40px;">
      <div>
        <h2 style="font-size: 28px; font-weight: 700; color: var(--ecosense-secondary); margin: 0;">Tus nodos</h2>
        <p style="color: var(--ecosense-secondary); opacity: 0.85; margin-top: 6px;">Crea y administra todos tus nodos de monitoreo</p>
      </div>
      <button
        id="open-create-node-modal"
        style="
          background: var(--ecosense-primary);
          color: var(--ecosense-secondary);
          padding: 14px 28px;
          border-radius: 16px;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 8px;
          border: none;
          cursor: pointer;
          box-shadow: 0 12px 30px rgba(118, 192, 221, 0.35);
          transition: 0.3s;
        "
      >
        <span class="material-symbols-outlined" style="font-size: 22px;">add</span>
        Nuevo nodo
      </button>
    </div>
    <!-- Nodes Table -->
    <div style="
      background: white;
      border-radius: 24px;
      box-shadow: 0 25px 60px rgba(30, 81, 89, 0.12);
      overflow: hidden;
    ">
      <!-- Barra de b煤squeda -->
      <div class="table-toolbar" id="table-toolbar" style="display: none;">
        <input type="text" id="table-search" class="table-search" placeholder="Buscar por nombre, ciudad, direcci贸n..." />
        <span id="table-search-count" style="font-size: 13px; color: var(--ecosense-secondary); opacity: 0.7;"></span>
      </div>

      <div style="overflow-x: auto;">
        <table class="nodes-table" style="width: 100%; min-width: 900px; border-collapse: collapse;">
          <thead>
            <tr>
              <th data-sort="name" style="padding: 16px 18px; text-align: left; font-weight: 700; font-size: 14px;">
                Nodo <span class="th-sort-icon material-symbols-outlined" data-sort-icon="name">unfold_more</span>
              </th>
              <th data-sort="location" style="padding: 16px 18px; text-align: left; font-weight: 700; font-size: 14px;">
                Ubicaci贸n <span class="th-sort-icon material-symbols-outlined" data-sort-icon="location">unfold_more</span>
              </th>
              <th data-sort="status" style="padding: 16px 18px; text-align: left; font-weight: 700; font-size: 14px;">
                Estado <span class="th-sort-icon material-symbols-outlined" data-sort-icon="status">unfold_more</span>
              </th>
              <th data-sort="sensors" style="padding: 16px 18px; text-align: left; font-weight: 700; font-size: 14px;">
                Sensores <span class="th-sort-icon material-symbols-outlined" data-sort-icon="sensors">unfold_more</span>
              </th>
              <th style="padding: 16px 18px; text-align: left; font-weight: 700; font-size: 14px;"></th>
            </tr>
          </thead>
          
          <tbody id="nodes-tbody" style="color: black;">
            <tr>
              <td colspan="5" style="text-align:center; padding:40px; color:black;">
                Cargando nodos...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginaci贸n -->
      <div class="table-pagination" id="table-pagination" style="display: none;">
        <span class="pagination-info" id="pagination-info"></span>
        <button type="button" class="pagination-btn" id="pagination-prev" title="P谩gina anterior">
          <span class="material-symbols-outlined" style="font-size: 20px;">chevron_left</span>
        </button>
        <div id="pagination-numbers" style="display: flex; gap: 4px;"></div>
        <button type="button" class="pagination-btn" id="pagination-next" title="P谩gina siguiente">
          <span class="material-symbols-outlined" style="font-size: 20px;">chevron_right</span>
        </button>
      </div>
      
      <div
        id="empty-state"
        style="display: none; text-align: center; padding: 60px 20px; color: var(--ecosense-secondary); opacity: 0.7;"
      >
        <span class="material-symbols-outlined" style="font-size: 64px; display: block; margin-bottom: 16px; color: var(--ecosense-primary);">hub</span>
        <h3 style="font-size: 22px; font-weight: 600;">No hay nodos a煤n</h3>
        <p style="margin-top: 6px;">Crea tu primer nodo con el bot贸n "Nuevo nodo"</p>
      </div>
    </div>
  </div>
  <!-- CREATE NODE MODAL -->
  <dialog id="createNodeModal" class="custom-modal">
    <div class="modal-header">
      <div class="modal-title">Crear Nuevo Nodo</div>
    </div>

    <form id="create-node-form" class="modal-body">

      <div class="input-group">
        <label>Nombre del Nodo</label>
        <input type="text" id="node-name" required />
      </div>

      <div class="input-group">
        <label>Direcci贸n</label>
        <input type="text" required id="node-address" />
      </div>

      <div class="input-group">
        <label>Ciudad</label>
        <input type="text" required id="node-city" />
      </div>

      <div class="row-2">
        <div class="input-group" style="flex:1;">
          <label>Latitud</label>
          <input type="number" required step="any" id="node-latitude" />
        </div>

        <div class="input-group" style="flex:1;">
          <label>Longitud</label>
          <input type="number" required step="any" id="node-longitude" />
        </div>
      </div>

      <div class="input-group">
        <label>Estado</label>
        <select id="node-status" required disabled>
          <option value="activo"> En L铆nea</option>
        </select>
      </div>

      <div class="input-group">
        <label>Notas</label>
        <textarea id="node-notes" rows="3"></textarea>
      </div>

      <div class="modal-actions">
        <button type="button" id="close-create-node-modal" class="btn-cancel">
          Cancelar
        </button>
        <button type="submit" class="btn-primary">
          Crear Nodo
        </button>
      </div>

    </form>
  </dialog>


  <!-- EDIT NODE MODAL -->
  <dialog id="editNodeModal" class="custom-modal">
    <div class="modal-header">
      <div class="modal-title">Editar Nodo</div>
    </div>

    <form id="edit-node-form" class="modal-body">

      <input type="hidden" id="edit-node-id" />

      <div class="input-group">
        <label>Nombre del Nodo *</label>
        <input type="text" id="edit-node-name" required />
      </div>

      <div class="input-group">
        <label>Direcci贸n</label>
        <input type="text" id="edit-node-address" />
      </div>

      <div class="input-group">
        <label>Ciudad</label>
        <input type="text" id="edit-node-city" />
      </div>

      <div class="row-2">
        <div class="input-group" style="flex:1;">
          <label>Latitud</label>
          <input type="number" step="any" id="edit-node-latitude" />
        </div>

        <div class="input-group" style="flex:1;">
          <label>Longitud</label>
          <input type="number" step="any" id="edit-node-longitude" />
        </div>
      </div>

      <div class="input-group">
        <label>Estado *</label>
        <select id="edit-node-status" required>
          <option value="activo"> En L铆nea</option>
          <option value="inactivo"> Fuera de L铆nea</option>
          <option value="mantenimiento"> Mantenimiento</option>
        </select>
      </div>

      <div class="input-group">
        <label>Notas</label>
        <textarea id="edit-node-notes" rows="3"></textarea>
      </div>

      <div class="modal-actions">
        <button type="button" id="close-edit-node-modal" class="btn-cancel">
          Cancelar
        </button>
        <button type="submit" class="btn-primary">
          Guardar Cambios
        </button>
      </div>

    </form>
  </dialog>
</div>

<script>
  // Modal handlers
  document.addEventListener('DOMContentLoaded', () => {
    const createNodeModal = document.getElementById('createNodeModal');
    const openBtn = document.getElementById('open-create-node-modal');
    const closeBtn = document.getElementById('close-create-node-modal');

    if (openBtn && createNodeModal) {
      openBtn.addEventListener('click', () => createNodeModal.showModal());
    }
    if (closeBtn && createNodeModal) {
      closeBtn.addEventListener('click', () => createNodeModal.close());
    }
  });

  // Estado de la tabla: datos, filtro, orden, paginaci贸n
  let allNodes = [];
  let tableState = { search: '', sortBy: 'name', sortDir: 'asc', page: 1, pageSize: 10 };

  function nodeMatchesSearch(n, q) {
    const qq = (q || '').toLowerCase().trim();
    if (!qq) return true;
    const text = `${n.name || ''} ${n.city || ''} ${n.address || ''}`.toLowerCase();
    return text.includes(qq);
  }

  function sortNodes(nodes) {
    const { sortBy, sortDir } = tableState;
    const mult = sortDir === 'asc' ? 1 : -1;
    return [...nodes].sort((a, b) => {
      let va, vb;
      if (sortBy === 'name') {
        va = (a.name || '').toLowerCase();
        vb = (b.name || '').toLowerCase();
      } else if (sortBy === 'location') {
        va = ((a.city || '') + (a.address || '')).toLowerCase();
        vb = ((b.city || '') + (b.address || '')).toLowerCase();
      } else if (sortBy === 'status') {
        const ord = { activo: 1, mantenimiento: 2, inactivo: 3 };
        va = ord[a.status] ?? 0;
        vb = ord[b.status] ?? 0;
      } else if (sortBy === 'sensors') {
        va = Number(a.sensor_count) || 0;
        vb = Number(b.sensor_count) || 0;
      } else return 0;
      if (typeof va === 'number' && typeof vb === 'number') return mult * (va - vb);
      if (va < vb) return -mult;
      if (va > vb) return mult;
      return 0;
    });
  }

  function renderTable() {
    const tbody = document.getElementById('nodes-tbody');
    const empty = document.getElementById('empty-state');
    const toolbar = document.getElementById('table-toolbar');
    const pagination = document.getElementById('table-pagination');

    const filtered = allNodes.filter(n => nodeMatchesSearch(n, tableState.search));
    const sorted = sortNodes(filtered);
    const total = sorted.length;
    const totalPages = Math.max(1, Math.ceil(total / tableState.pageSize));
    tableState.page = Math.min(tableState.page, totalPages);
    const start = (tableState.page - 1) * tableState.pageSize;
    const pageNodes = sorted.slice(start, start + tableState.pageSize);

    if (allNodes.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px; color: var(--ecosense-secondary);">Cargando nodos...</td></tr>';
      empty.style.display = 'none';
      toolbar.style.display = 'none';
      pagination.style.display = 'none';
      return;
    }

    if (total === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px; color: var(--ecosense-secondary);">No hay resultados para tu b煤squeda.</td></tr>';
      empty.style.display = 'none';
      toolbar.style.display = 'flex';
      pagination.style.display = 'none';
      document.getElementById('table-search-count').textContent = '0 nodos';
      return;
    }

    empty.style.display = 'none';
    toolbar.style.display = 'flex';
    pagination.style.display = 'flex';

    const searchCount = document.getElementById('table-search-count');
    searchCount.textContent = tableState.search ? `${total} de ${allNodes.length} nodos` : `${total} nodo${total !== 1 ? 's' : ''}`;

    tbody.innerHTML = pageNodes.map(n => {
      const statusStyles = n.status === 'activo' ? { bg: 'rgba(17, 182, 87, 0.15)', border: 'rgba(17, 182, 87, 0.4)', color: 'var(--ecosense-positive)', dot: 'var(--ecosense-positive)' } :
        n.status === 'inactivo' ? { bg: 'rgba(232, 38, 89, 0.15)', border: 'rgba(232, 38, 89, 0.4)', color: 'var(--ecosense-negative)', dot: 'var(--ecosense-negative)' } :
        { bg: 'rgba(250, 202, 42, 0.25)', border: 'rgba(250, 202, 42, 0.5)', color: 'var(--ecosense-secondary)', dot: 'var(--ecosense-alert)' };
      const statusLabel = n.status === 'activo' ? 'En l铆nea' : n.status === 'inactivo' ? 'Fuera de l铆nea' : 'Mantenimiento';
      const nodeLabel = (n.name || 'N/A') + (n.city ? ` (${n.city})` : '');
      return `
        <tr style="transition:0.2s; cursor:pointer;">
          <td style="padding:14px 18px; font-weight:600; color: var(--ecosense-secondary);">${nodeLabel}</td>
          <td style="padding:14px 18px; color: var(--ecosense-secondary); opacity: 0.85;">${[n.address, n.city].filter(Boolean).join(', ') || '-'}</td>
          <td style="padding:14px 18px;">
            <span style="display:inline-flex;align-items:center;gap:8px;padding:6px 14px;border-radius:999px;font-size:13px;font-weight:600;border:1px solid ${statusStyles.border};background:${statusStyles.bg};color:${statusStyles.color};">
              <span style="width:8px;height:8px;border-radius:50%;background:${statusStyles.dot};"></span>
              ${statusLabel}
            </span>
          </td>
          <td style="padding:14px 18px; color: var(--ecosense-secondary);">${n.sensor_count || 0}</td>
          <td style="padding:14px 18px; display:flex; gap:6px;">
            <button onclick="editNode(${n.id})" style="padding:6px 12px;border-radius:12px;border:none;background:var(--ecosense-primary-soft-2);color:var(--ecosense-secondary);font-weight:600;cursor:pointer;" title="Editar nodo"><span class="material-symbols-outlined" style="font-size:20px;">edit</span></button>
            <button onclick="copyApiKey(this.dataset.key)" data-key="${(n.api_key || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" style="padding:6px 12px;border-radius:12px;border:none;background:rgba(17, 182, 87, 0.15);color:var(--ecosense-positive);font-weight:600;cursor:pointer;" title="Copiar API Key"><span class="material-symbols-outlined" style="font-size:20px;">key</span></button>
          </td>
        </tr>
      `;
    }).join('');

    // Actualizar iconos de orden
    document.querySelectorAll('.nodes-table thead th[data-sort] .th-sort-icon').forEach(icon => {
      const col = icon.closest('th').dataset.sort;
      icon.textContent = col === tableState.sortBy ? (tableState.sortDir === 'asc' ? 'expand_more' : 'expand_less') : 'unfold_more';
    });

    // Paginaci贸n
    const infoEl = document.getElementById('pagination-info');
    infoEl.textContent = `${start + 1}-${Math.min(start + tableState.pageSize, total)} de ${total}`;

    const prevBtn = document.getElementById('pagination-prev');
    const nextBtn = document.getElementById('pagination-next');
    prevBtn.disabled = tableState.page <= 1;
    nextBtn.disabled = tableState.page >= totalPages;

    const numbersEl = document.getElementById('pagination-numbers');
    numbersEl.innerHTML = '';
    const showPages = 5;
    let from = Math.max(1, tableState.page - Math.floor(showPages / 2));
    let to = Math.min(totalPages, from + showPages - 1);
    if (to - from < showPages - 1) from = Math.max(1, to - showPages + 1);
    for (let i = from; i <= to; i++) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'pagination-btn' + (i === tableState.page ? ' active' : '');
      btn.textContent = i;
      btn.onclick = () => { tableState.page = i; renderTable(); };
      numbersEl.appendChild(btn);
    }
  }

  async function loadNodes() {
    try {
      const res = await fetch('/api/nodes');
      const nodes = await res.json();
      const tbody = document.getElementById('nodes-tbody');
      const empty = document.getElementById('empty-state');
      if (!Array.isArray(nodes) || nodes.length === 0) {
        allNodes = [];
        renderTable();
        tbody.innerHTML = '';
        empty.style.display = 'block';
        document.getElementById('table-toolbar').style.display = 'none';
        document.getElementById('table-pagination').style.display = 'none';
        return;
      }
      allNodes = nodes;
      tableState.page = 1;
      renderTable();
    } catch (err) {
      console.error(err);
      document.getElementById('nodes-tbody').innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--ecosense-negative); padding:20px;">Error cargando nodos</td></tr>';
    }
  }

  // Eventos de ordenamiento
  document.querySelectorAll('.nodes-table thead th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.sort;
      if (tableState.sortBy === col) {
        tableState.sortDir = tableState.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        tableState.sortBy = col;
        tableState.sortDir = 'asc';
      }
      tableState.page = 1;
      renderTable();
    });
  });

  // Evento de b煤squeda
  const searchInput = document.getElementById('table-search');
  if (searchInput) {
    let searchTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        tableState.search = searchInput.value;
        tableState.page = 1;
        renderTable();
      }, 250);
    });
  }

  // Botones prev/next paginaci贸n
  document.getElementById('pagination-prev').addEventListener('click', () => {
    if (tableState.page > 1) { tableState.page--; renderTable(); }
  });
  document.getElementById('pagination-next').addEventListener('click', () => {
    const totalPages = Math.max(1, Math.ceil(allNodes.filter(n => nodeMatchesSearch(n, tableState.search)).length / tableState.pageSize));
    if (tableState.page < totalPages) { tableState.page++; renderTable(); }
  });

  // Node form submission
  document.getElementById('create-node-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const data = {
      name: document.getElementById('node-name').value.trim(),
      status: document.getElementById('node-status').value,
      address: (document.getElementById('node-address').value || '').trim() || null,
      city: (document.getElementById('node-city').value || '').trim() || null,
      latitude: (document.getElementById('node-latitude').value || '').trim() || null,
      longitude: (document.getElementById('node-longitude').value || '').trim() || null,
      notes: (document.getElementById('node-notes').value || '').trim() || null
    };
    try {
      const res = await fetch('/api/nodes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:  JSON.stringify(data)
      });
      if(res.ok){
        document.getElementById('create-node-form').reset();
        document.getElementById('createNodeModal').close();
        loadNodes();
        const alert = document.createElement('div');
        alert.style.cssText = "position:fixed;bottom:20px;right:20px;padding:12px 20px;background:var(--ecosense-positive);color:white;border-radius:14px;box-shadow:0 12px 30px rgba(30, 81, 89, 0.2);font-weight:600;";
        alert.textContent = "Nodo creado exitosamente";
        document.body.appendChild(alert);
        setTimeout(()=>alert.remove(),3000);
      }else{
        const err = await res.json();
        alert(`Error: ${err.error || 'No se pudo crear el nodo'}`);
      }
    } catch(err){
      console.error(err);
      alert('Error al crear el nodo');
    }
  });
  
  // Cerrar modales al hacer clic fuera (en el backdrop)
  [createNodeModal, editNodeModal].forEach(modal => {
    modal.addEventListener('click', (e) => {
      const dialogDimensions = modal.getBoundingClientRect();
      if (
        e.clientX < dialogDimensions.left ||
        e.clientX > dialogDimensions.right ||
        e.clientY < dialogDimensions.top ||
        e.clientY > dialogDimensions.bottom
      ) {
        modal.close();
      }
    });
  });

  function editNode(id) {
    fetch(`/api/nodes`)
      .then(r => r.json())
      .then(nodes => {
        const node = nodes.find(n => n.id === id);
        if (!node) return alert("Nodo no encontrado");

        document.getElementById("edit-node-id").value = id;
        document.getElementById("edit-node-name").value = node.name;
        document.getElementById("edit-node-address").value = node.address || "";
        document.getElementById("edit-node-city").value = node.city || "";
        document.getElementById("edit-node-latitude").value = node.latitude || "";
        document.getElementById("edit-node-longitude").value = node.longitude || "";
        document.getElementById("edit-node-notes").value = node.notes || "";
        document.getElementById("edit-node-status").value = node.status;

        document.getElementById("editNodeModal").showModal();
      });
  }

  document.getElementById("close-edit-node-modal")
    .addEventListener("click", () => {
      document.getElementById("editNodeModal").close();
    });

  document.getElementById("edit-node-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const id = document.getElementById("edit-node-id").value;
      const data = {
        name: document.getElementById("edit-node-name").value.trim(),
        status: document.getElementById("edit-node-status").value,
        address: (document.getElementById("edit-node-address").value || "").trim() || null,
        city: (document.getElementById("edit-node-city").value || "").trim() || null,
        latitude: (document.getElementById("edit-node-latitude").value || "").trim() || null,
        longitude: (document.getElementById("edit-node-longitude").value || "").trim() || null,
        notes: (document.getElementById("edit-node-notes").value || "").trim() || null
      };
      console.log(data);
      const res = await fetch(`/api/nodes/${id}`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      });

      if (res.ok) {
        document.getElementById("editNodeModal").close();
        loadNodes();

        const alert = document.createElement("div");
        alert.style.cssText =
          "position:fixed;bottom:20px;right:20px;padding:12px 20px;background:var(--ecosense-positive);color:white;border-radius:14px;font-weight:600;";
        alert.textContent = "Nodo actualizado correctamente";
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
      } else {
        alert("Error al actualizar el nodo");
      }
    });

  function copyApiKey(key) {
    if (!key) return;
    navigator.clipboard.writeText(key).then(() => {
      const alert = document.createElement('div');
      alert.style.cssText = "position:fixed;bottom:20px;right:20px;padding:12px 20px;background:var(--ecosense-positive);color:white;border-radius:14px;box-shadow:0 12px 30px rgba(30, 81, 89, 0.2);font-weight:600;";
      alert.textContent = "API Key copiada al portapapeles";
      document.body.appendChild(alert);
      setTimeout(() => alert.remove(), 2500);
    }).catch(() => alert('No se pudo copiar'));
  }

  // Load nodes initially
  loadNodes();
  
  // Manejo del dropdown de configuraciones
  (function () {
    const settingsButton = document.getElementById("settings-button");
    const settingsDropdown = document.getElementById("settings-dropdown");
    const settingsContainer = document.getElementById("settings-dropdown-container");

    if (!settingsButton || !settingsDropdown) return;

    function toggleDropdown() {
      const isVisible = settingsDropdown.style.display === "block";
      settingsDropdown.style.display = isVisible ? "none" : "block";
    }

    function closeDropdown() {
      settingsDropdown.style.display = "none";
    }

    // Toggle al hacer click en el bot贸n
    settingsButton.addEventListener("click", function (e) {
      e.stopPropagation();
      toggleDropdown();
    });

    // Cerrar al hacer click fuera del dropdown
    document.addEventListener("click", function (e) {
      if (settingsContainer && !settingsContainer.contains(e.target)) {
        closeDropdown();
      }
    });

    // Prevenir que el click dentro del dropdown lo cierre
    settingsDropdown.addEventListener("click", function (e) {
      e.stopPropagation();
    });
  })();
</script>