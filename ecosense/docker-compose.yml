services:
    db:
      image: mysql:8.0
      container_name: ecosense_db
      restart: always
      environment:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: ecosense_dev
        MYSQL_USER: ecosense
        MYSQL_PASSWORD: ecosense
      ports:
        - "3306:3306"
      volumes:
        - db_data:/var/lib/mysql
      healthcheck:
        test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
        interval: 5s
        timeout: 5s
        retries: 10

    web:
      image: elixir:1.15
      container_name: ecosense_web
      working_dir: /app
      volumes:
        - .:/app
      ports:
        - "4000:4000"
      depends_on:
        db:
          condition: service_healthy
      command: >
        bash -c "
        mix local.hex --force &&
        mix local.rebar --force &&
        mix deps.get &&
        mix ecto.create &&
        mix ecto.migrate &&
        mix phx.server
        "

volumes:
  db_data:
